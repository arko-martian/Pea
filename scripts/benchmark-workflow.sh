#!/bin/bash
# Complete benchmarking workflow with profiling, comparison, storage, and regression detection

set -e

echo "üöÄ Running complete benchmarking workflow..."

# Make sure all scripts are executable
chmod +x scripts/*.sh

# Step 1: Run criterion benchmarks with profiling
echo ""
echo "üìä Step 1/6: Running criterion benchmarks with flamegraph profiling..."
cargo bench -p pea-benchmarks

# Step 2: Run hyperfine comparisons
echo ""
echo "üèÅ Step 2/6: Running hyperfine package manager comparisons..."
if command -v hyperfine &> /dev/null; then
    ./scripts/bench-all.sh
else
    echo "‚ö†Ô∏è  Hyperfine not found. Skipping package manager comparisons."
    echo "   Install with: brew install hyperfine"
fi

# Step 3: Store benchmark results
echo ""
echo "üíæ Step 3/6: Storing benchmark results..."
./scripts/store-benchmark-results.sh

# Step 4: Generate trend report
echo ""
echo "üìà Step 4/6: Generating trend report..."
./scripts/generate-trend-report.sh

# Step 5: Detect regressions
echo ""
echo "üîç Step 5/6: Detecting performance regressions..."
if ./scripts/detect-regressions.sh; then
    REGRESSION_STATUS="‚úÖ No regressions"
else
    REGRESSION_STATUS="üî¥ Regressions detected"
fi

# Step 6: Generate summary
echo ""
echo "üìã Step 6/6: Generating workflow summary..."

SUMMARY_FILE="benchmark-workflow-summary.md"

cat > "$SUMMARY_FILE" << EOF
# Benchmark Workflow Summary

**Date**: $(date)
**Git Commit**: $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
**Git Branch**: $(git branch --show-current 2>/dev/null || echo "unknown")

## Workflow Results

### 1. Criterion Benchmarks ‚úÖ
- **Status**: Completed
- **Results**: Available in \`target/criterion/\`
- **Flamegraphs**: Generated for performance profiling

### 2. Hyperfine Comparisons
EOF

if command -v hyperfine &> /dev/null; then
    echo "- **Status**: ‚úÖ Completed" >> "$SUMMARY_FILE"
    echo "- **Cold Start**: $([ -f "cold-start-benchmark.json" ] && echo "‚úÖ" || echo "‚ùå")" >> "$SUMMARY_FILE"
    echo "- **Resolution**: $([ -f "resolve-benchmark.json" ] && echo "‚úÖ" || echo "‚ùå")" >> "$SUMMARY_FILE"
    echo "- **Installation**: $([ -f "install-benchmark.json" ] && echo "‚úÖ" || echo "‚ùå")" >> "$SUMMARY_FILE"
else
    echo "- **Status**: ‚ö†Ô∏è Skipped (hyperfine not installed)" >> "$SUMMARY_FILE"
fi

cat >> "$SUMMARY_FILE" << EOF

### 3. Result Storage ‚úÖ
- **Status**: Completed
- **Location**: \`benchmark-results/\`
- **Latest**: \`benchmark-results/latest_summary.json\`

### 4. Trend Analysis ‚úÖ
- **Status**: Completed
- **Report**: \`benchmark-trend-report.md\`

### 5. Regression Detection
- **Status**: $REGRESSION_STATUS
- **Report**: \`regression-report.md\`

## Generated Files

### Profiling
- Flamegraphs in \`target/criterion/*/profile/flamegraph.svg\`

### Comparisons
EOF

for file in *-benchmark.json *-benchmark.md; do
    if [ -f "$file" ]; then
        echo "- \`$file\`" >> "$SUMMARY_FILE"
    fi
done

cat >> "$SUMMARY_FILE" << EOF

### Reports
- \`benchmark-trend-report.md\` - Historical performance trends
- \`regression-report.md\` - Regression analysis
- \`benchmark-workflow-summary.md\` - This summary

### Data Storage
- \`benchmark-results/\` - Historical benchmark data
- \`benchmark-results/latest_summary.json\` - Latest results
- \`benchmark-results/latest_metadata.json\` - Latest metadata

## Performance Targets

- **Cold Start**: <5ms ‚è±Ô∏è
- **Resolution**: Competitive with fastest PM üèÅ
- **Installation**: Competitive with fastest PM üì¶

## Next Steps

EOF

if [ "$REGRESSION_STATUS" = "üî¥ Regressions detected" ]; then
    cat >> "$SUMMARY_FILE" << EOF
1. üî¥ **URGENT**: Fix performance regressions identified in regression report
2. Re-run benchmarks after fixes
3. Verify regression resolution
EOF
else
    cat >> "$SUMMARY_FILE" << EOF
1. ‚úÖ Performance is within acceptable range
2. Review flamegraphs for optimization opportunities
3. Compare against other package managers for competitive analysis
EOF
fi

cat >> "$SUMMARY_FILE" << EOF

---
*Generated by benchmark workflow on $(date)*
EOF

echo ""
echo "‚úÖ Benchmarking workflow complete!"
echo ""
echo "üìä Summary:"
echo "  - Criterion benchmarks: ‚úÖ"
echo "  - Hyperfine comparisons: $(command -v hyperfine &> /dev/null && echo "‚úÖ" || echo "‚ö†Ô∏è ")"
echo "  - Result storage: ‚úÖ"
echo "  - Trend analysis: ‚úÖ"
echo "  - Regression detection: $REGRESSION_STATUS"
echo ""
echo "üìÅ Key files:"
echo "  - Summary: $SUMMARY_FILE"
echo "  - Trends: benchmark-trend-report.md"
echo "  - Regressions: regression-report.md"
echo "  - Data: benchmark-results/"

# Exit with error code if regressions detected
if [ "$REGRESSION_STATUS" = "üî¥ Regressions detected" ]; then
    exit 1
fi